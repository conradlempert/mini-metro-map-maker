(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function o(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=o(i);fetch(i.href,r)}})();let h="selectTool";const s=$("#mainCanvas")[0],l=s.getContext("2d");l.globalAlpha=.4;let a=[];const P=6,X=1.5;let y,R=1,d={x:0,y:0},C=!1,g=!1,c,f=!1,w=!1;$("#newMap").on("click",Y);$("#uploadMapButton").on("click",D);$("#uploadMapFile").on("change",U);$("#selectTool").on("click",()=>M("selectTool"));$("#markerTool").on("click",()=>M("markerTool"));$("#polygonTool").on("click",()=>M("polygonTool"));$("#export").on("click",ne);$("#help").on("click",j);$("#closeModalButton").on("click",N);$("#createCityMapButton").on("click",_);$("#closeHelp").on("click",J);window.onbeforeunload=function(e){if(f){const t="Are you sure you want to leave? Download your shapes as JSON to save your progress.";return(e||window.event).returnValue=t,t}else return null};function Y(){$("#start").hide(),$("#createModal").show()}function D(){$("#uploadMapFile").trigger("click")}function N(){$("#start").show(),$("#createModal").hide()}function j(){$("#helpModal").show()}function J(){$("#helpModal").hide()}function U(){const e=$("#uploadMapFile").prop("files")[0];if(e){const t=new FileReader;t.readAsText(e),t.addEventListener("load",o=>{const n=o.target;var i=JSON.parse(n.result);a=i.elements,s.width=i.width,s.height=i.height,w=i.desaturate,i.image?A(i.image):$("#backgroundCanvas").hide(),L(),d=i.origin,p()})}}function _(){w=$("#desaturate").prop("checked");const e=$("#background_image").prop("files")[0];if(s.width=parseInt($("#city_width").val()),s.height=parseInt($("#city_height").val()),L(),d={x:parseInt($("#origin_x").val()),y:parseInt($("#origin_y").val())},e){const t=new FileReader;t.readAsDataURL(e),t.addEventListener("load",()=>{A(t.result)})}else $("#backgroundCanvas").hide();f=!0}function A(e){y=new Image,y.onload=function(){Z()},y.src=e}function L(){$("#start").hide(),$("#createModal").hide(),$("#mainWrapper").css("display","inline-block"),$("#clipboardWrapper").css("display","inline-block"),$("#canvasContainer").width($(s).width()),$("#canvasContainer").height($(s).height()),$(document).on("mousemove",K),$(s).on("mousedown",H),$(document).on("mouseup",W),$(document).on("keydown",oe),$(document).on("keyup",te),R=s.height/s.getBoundingClientRect().height}function M(e){h!==e&&($("#"+h).removeClass("btn-dark").addClass("btn-outline-dark"),$("#"+e).removeClass("btn-outline-dark").addClass("btn-dark"),h=e,E())}function z(e){if(v(e)){const t=m(e);$("#coordinate").text(t.x+", "+t.y)}else $("#coordinate").html("&nbsp;")}function v(e){const t=e.clientX,o=e.clientY,n=s.getBoundingClientRect();return t>n.left&&t<n.right&&o>n.top&&o<n.bottom}function m(e){const t=e.clientX,o=e.clientY,n=s.getBoundingClientRect(),i=(t-n.left)/n.width*s.width-d.x,r=-((o-n.top)/n.height*s.height-d.y);return{x:Math.round(i),y:Math.round(r)}}function b(e){return{x:e.x+d.x,y:-e.y+d.y}}function O(e){const t=s.getBoundingClientRect();return{x:(e.x+d.x)/s.width*t.width+t.left,y:(-e.y+d.y)/s.height*t.height+t.top}}function H(e){const t=F(e);t&&(c=t,s.style.cursor="grabbing"),g=!1}function K(e){z(e),g=!0,c?(document.getSelection().removeAllRanges(),q(e)):F(e)?s.style.cursor="pointer":s.style.cursor="initial"}function W(e){c&&!g&&G(),!c&&!g&&V(e),c&&T(c),c=void 0,g=!1}function q(e){if(f=!0,v(e)){const t=m(e);if(c){if(c.type=="singleMarker")c.x=t.x,c.y=t.y;else if(c.type=="polygon"){const o=c.positions[c.pickedPosition];o.x=t.x,o.y=t.y}}}k()!==c&&x(c),p()}function V(e){if(v(e))if(h==="markerTool"){const t=m(e),o={x:t.x,y:t.y,selected:!1,type:"singleMarker"};a.push(o),x(o),f=!0}else if(h==="polygonTool"){const t=m(e),o=k();if(o&&o.type==="polygon")o.positions.push(t),T(o),p();else{const n={type:"polygon",positions:[t],selected:!1,pickedPosition:-1};a.push(n),x(n)}f=!0}else h==="selectTool"&&E()}function G(){c&&(C?Q(c):x(c))}function Q(e){if(f=!0,e.type=="singleMarker"||e.type=="polygon"&&e.positions.length===1)x(e),I();else{const t=e.pickedPosition;e.positions.splice(t,1),p()}}function Z(){const e=$("#backgroundCanvas")[0];e.width=s.width,e.height=s.height;const t=e.getContext("2d");w&&(t.globalAlpha=.4),t.drawImage(y,0,0,e.width,e.height)}function p(){l.clearRect(0,0,s.width,s.height),a.forEach(e=>{e.type==="singleMarker"?B(e,e.selected):e.type==="polygon"&&ee(e)})}function ee(e){e.positions.forEach(o=>{B(o,e.selected)}),l.beginPath(),l.strokeStyle=e.selected?"red":"black",l.lineWidth=3;const t=b(e.positions[0]);l.moveTo(t.x,t.y),e.positions.slice(1).forEach(o=>{const n=b(o);l.lineTo(n.x,n.y)}),l.lineTo(t.x,t.y),l.closePath(),l.stroke()}function B(e,t){const o=b(e),n=P*R;t?(l.fillStyle="red",l.font=n*X+"px Arial",l.textAlign="center",l.fillText(e.x+", "+e.y,o.x,o.y-n*2)):l.fillStyle="black",l.fillRect(o.x-n/2,o.y-n/2,n,n)}function T(e){let t="";e.type=="singleMarker"?t=JSON.stringify([e.x,e.y]):e.type=="polygon"&&(t=JSON.stringify(e.positions.map(o=>[o.x,o.y]))),S(t)}function S(e){var t=document.createElement("textarea");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="2em",t.style.height="2em",t.style.padding="0",t.style.border="none",t.style.outline="none",t.style.boxShadow="none",t.style.background="transparent",t.value=e,document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),$("#clipboard").text(e)}catch{$("#clipboard").text("Error while copying text")}document.body.removeChild(t)}function k(){return a.find(e=>e.selected)}function x(e){const t=k();t&&(t.selected=!1),e.selected=!0,T(e),p()}function F(e){const t=P/2;return a.find(n=>{if(n.type=="singleMarker"){const i=O(n);if(e.clientX>i.x-t&&e.clientX<i.x+t&&e.clientY>i.y-t&&e.clientY<i.y+t)return!0}else if(n.type=="polygon")return n.positions.some((i,r)=>{const u=O(i);if(e.clientX>u.x-t&&e.clientX<u.x+t&&e.clientY>u.y-t&&e.clientY<u.y+t)return n.pickedPosition=r,!0})})}function I(){f=!0;const e=k();if(e){const t=a.indexOf(e);a.splice(t,1),S(""),p()}}function te(e){e.keyCode==8&&I(),e.keyCode==27&&E(),e.keyCode==16&&(C=!1)}function oe(e){e.keyCode==16&&(C=!0,document.getSelection().removeAllRanges())}function E(){const e=k();e&&(e.selected=!1,p()),S("")}function ne(){f=!1;const e={version:"1.0",width:s.width,height:s.height,elements:a,desaturate:w,origin:d};y&&(e.image=y.src);let t=document.createElement("a");t.download="shapes.json",t.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),document.body.appendChild(t),t.click(),document.body.removeChild(t)}
